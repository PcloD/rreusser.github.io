<!DOCTYPE html>
<html class='no-js'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width' name='viewport'>
    <link href="../../../../stylesheets/demo-9aa7243a.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <script src="../../../../javascripts/demo-0971ac80.js" type="text/javascript"></script>
    <script>
      window.frame = new FrameInstance();
    </script>
    <style>
      #plot {
        height: 600px;
        width: 600px;
        padding: 0;
        margin: 0;
        display: block;
      }
      body {
        margin: 0;
        padding: 0;
      }
    </style>
    
    <canvas id="plot"></canvas>
    
    <script src="../../../../black-hole-trajectory-demo/underscore-min-1b16e915.js"></script>
    <script src="../../../../black-hole-trajectory-demo/jquery.browser-1659c04f.js"></script>
    <script src="../../../../black-hole-trajectory-demo/jquery.disabletextselect-36f953aa.js"></script>
    <script src="../../../../black-hole-trajectory-demo/plotter-d10407d5.js"></script>
    <script src="../../../../black-hole-trajectory-demo/rk-e00082f8.js"></script>
    
    <script type='text/javascript'>
      
      var deriv, xyz_to_rpt, dxyz_to_rpt;
      var i,j,l,n,rs,c;
      var r, theta, phi, n;
      
      c = 1.0;
      rs = 1.0;
      
      // Derivative function for the Schwarzschild solution
      var deriv = function(y,s) {
        if(y[0] < rs*1.01 || y[0] > rs*1000.0 ) {
          return new Array(NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN);
        } else {
          return new Array(
            y[4], y[5], y[6], y[7],
            rs*0.5/y[0]/(y[0]-rs)*y[4]*y[4] +
            (y[0]-rs)*y[5]*y[5] +
            (y[0]-rs)*Math.pow(Math.sin(y[1])*y[6],2) +
            c*c*rs*(rs-y[0])*0.5/Math.pow(y[0],3)*y[7]*y[7],
            -2.0/y[0]*y[4]*y[5] + Math.sin(y[1])*Math.cos(y[1])*y[6]*y[6],
            -2.0/y[0]*y[4]*y[6] - 2.0/Math.tan(y[1])*y[5]*y[6],
            rs/y[0]/(rs-y[0])*y[4]*y[7]
          );
        }
      }
      
      // Rectangular coordinates -> Spherical coordinates
      var xyz_to_rpt = function(xR) {
        var ret = new Array(3);
        ret[0] = Math.sqrt(xR[0]*xR[0]+xR[1]*xR[1]+xR[2]*xR[2]);
        ret[1] = Math.acos(xR[2]/ret[0]);
        ret[2] = Math.atan2(xR[1],xR[0]);
        return ret;
      }
      
      // Rectangular velocity -> Spherical velocity
      var dxyz_to_drpt = function(x, dxR) {
        return new Array(
          Math.cos(x[2])*Math.sin(x[1])*dxR[0] +
          Math.sin(x[2])*Math.sin(x[1])*dxR[1] +
          Math.cos(x[1])*dxR[2],
              
          Math.cos(x[2])*Math.cos(x[1])/x[0]*dxR[0] + 
          Math.sin(x[2])*Math.cos(x[1])/x[0]*dxR[1] - 
          Math.sin(x[1])/x[0]*dxR[2],
                    
         -Math.sin(x[2])/Math.sin(x[1])/x[0]*dxR[0] + 
          Math.cos(x[2])/Math.sin(x[1])/x[0]*dxR[1]
        );
      }
      
      var calculate_trajectory = function( x0R, dx0R ) {
        var n, dt, x0, x0d, f0, f, x, y, z;
        n = 1000;
        dt = 0.1;
        
        x0 = xyz_to_rpt(x0R);
        x0d= dxyz_to_drpt(x0,dx0R);
        var A = 1.0 - rs/x0[0];
        f0 = new Array( x0[0], x0[1], x0[2], 0.0, x0d[0]*A, x0d[1]*A, x0d[2]*A, 1.0 )
        
        f = rk45( deriv, f0, 0.0, dt, n, true );
        var n = f.length
        x = new Array(n), y = new Array(n), z = new Array(n);
        for(i=0; i<n; i++) {
          x[i] = f[i][0]*Math.cos(f[i][2])*Math.sin(f[i][1]);
          y[i] = f[i][0]*Math.sin(f[i][2])*Math.sin(f[i][1]);
          z[i] = f[i][0]*Math.cos(f[i][2]);
        }
        return {x:x,y:y,z:z}
      }
      
     
    
      
      $(function() {
        var s = '#plot';
        var w = $(s).closest('p').width();
        var h = w;
        
        $(s).width(w);
        $(s).height(h);
        window.pl = new Plot(s);
          
        pl.add_axis();
        pl.grid();
        pl.axis(-5.5,5.5,-5.5,5.5);
        
        var x0 = 3.68;
        var y0 = 0;
        var dx0 = 0.0;
        var dy0 = 0.4999;
        var vscale = 2.0/(pl.gca().xmax-pl.gca().xmin);
        
        var plot_trajectory = function(x0, y0, dx0, dy0) {
          result = calculate_trajectory( [x0, y0,0], [dx0, dy0, 0] );
          pl.clf()
          pl.add_artist(new Circle(0,0,1, {fc:'#000'}));
          pl.plot(result.x,result.y, {color:'#4747ca'})
          pl.add_artist(new Circle(x0,y0,0.05, {fc:'#ca4747', color: '#ca4747'}));
          pl.plot([x0,x0+dx0/vscale],[y0,y0+dy0/vscale], {color:'#ca4747'});
          pl.gca().clear()
          pl.show()
        }
        
        var click_trajectory = function(e) {
          vscale = 2.0/(pl.gca().xmax-pl.gca().xmin);
          var ax, x1, y1;
          ax = this.gca();
          if(e.altKey) {
            x1 = ax.x(e.offsetX * window.devicePixelRatio);
            y1 = ax.y(e.offsetY * window.devicePixelRatio);
            dx0 = (x1-x0)*vscale;
            dy0 = (y1-y0)*vscale;
          } else {
            x0 = ax.x(e.offsetX * window.devicePixelRatio);
            y0 = ax.y(e.offsetY * window.devicePixelRatio);
          }
          var v = Math.sqrt(dx0*dx0+dy0*dy0);
          if(v>1.0) {
            dx0 /= v;
            dy0 /= v;
          }
          plot_trajectory(x0,y0,dx0,dy0);
        }
        pl.onmove(function(e) {
          click_trajectory.bind(this)(e);
        });
        plot_trajectory(x0,y0,dx0,dy0);
        pl.gca().clear()
        pl.show();
    
    
        $(window).resize(function() {
          pl.resize(window.innerWidth,window.innerHeight);
        }).trigger('resize');
        
    
        frame.on('resize',function(event,data) {
          pl.resize(data.width,data.height);
        });
      });
    
    </script>
    <script>
      var _gaq=[['_setAccount','UA-50197543-4'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
  </body>
</html>
