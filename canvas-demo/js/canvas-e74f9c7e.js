window.CTK=window.CTK||{},CTK.AbstractCanvas=Class.extend({init:function(t){return this.options=jQuery.extend({id:t.parentId+"-canvas",pixelRatio:window.devicePixelRatio},t),this.canvas=document.createElement("canvas"),this.canvas.id=this.options.id,this.$canvas=$(this.canvas),this.pixRat=this.options.pixelRatio,this.ctx=this.canvas.getContext("2d"),this.mirrorers=[],this.setUp(),this.onresizeCallback=this.options.onresizeCallback||null,this.options.fill&&this.fill(this.options.fill),this},addMirrorer:function(t){this.mirrorers.push(t)},resizeMirrorers:function(){for(var t=this.mirrorers.length-1;t>=0;t--)this.mirrorers[t].resizeCanvas(this.canvas.width,this.canvas.height)},resize:function(t){return this.onresizeCallback=t.bind(this),this},resizeCanvas:function(){this.resizeMirrorers(),this.onresizeCallback&&this.onresizeCallback()},blit:function(t){this.ctx.drawImage(t,0,0)},drawTo:function(t){t.ctx.drawImage(this.canvas,0,0)},copyTo:function(t,i){var s=t.ctx;s.save(),s.globalCompositeOperation=i||"copy",s.drawImage(this.canvas,0,0),s.restore()},drawFrom:function(t){this.ctx.drawImage(t.canvas,0,0)},copyFrom:function(t,i){var s=this.ctx;s.save(),s.globalCompositeOperation=i||"copy",s.drawImage(t.canvas,0,0),s.restore()},coverWith:function(t,i){var s=this.ctx;s.save(),s.globalCompositeOperation=i||"copy",s.drawImage(t.el,0,0),s.restore()},clear:function(){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this},fill:function(t){var i=this.ctx;t&&(i.fillStyle=t),i.fillRect(0,0,this.width,this.height)},setCover:function(t,i){var s=this.ctx,a=this.width/t,e=this.height/i;if(s.setTransform(1,0,0,1,0,0),a>e){var h=.5*(this.height-i*a);s.translate(0,h),s.scale(a,a)}else{var n=.5*(this.width-t*e);s.translate(n,0),s.scale(e,e)}return this},setContain:function(t,i){var s=this.ctx,a=this.width/t,e=this.height/i;if(s.setTransform(1,0,0,1,0,0),e>a){var h=.5*(this.height-i*a);s.translate(0,h),s.scale(a,a)}else{var n=.5*(this.width-t*e);s.translate(n,0),s.scale(e,e)}return this}}),Object.defineProperties(CTK.AbstractCanvas.prototype,{width:{get:function(){return this.canvas.width}},height:{get:function(){return this.canvas.height}}}),CTK.OffscreenCanvas=CTK.AbstractCanvas.extend({setUp:function(){void 0===this.options.mirror?(this.canvas.width=Math.max(0,this.options.width),this.canvas.height=Math.max(0,this.options.height)):(this.mirror=this.options.mirror,this.mirror.addMirrorer(this),this.pixRat=this.mirror.pixRat,this.canvas.width=Math.max(0,this.mirror.canvas.width),this.canvas.height=Math.max(0,this.mirror.canvas.height))},resizeCanvas:function(t,i){this.canvas.width=Math.max(0,t),this.canvas.height=Math.max(0,i),this.ctx=this.canvas.getContext("2d"),this._super()}}),CTK.DOMCanvas=CTK.AbstractCanvas.extend({setUp:function(){this.$parent=$(document.getElementById(this.options.parentId)),this.$parent.append(this.$canvas),this.enableResize(),this.resizeCanvas()},resizeCanvas:function(){this.$canvas.css({width:this.$parent.width()}),this.$canvas.css({height:this.$parent.height()}),this.canvas.width=this.$parent.width()*this.pixRat,this.canvas.height=this.$parent.height()*this.pixRat,this.width=this.canvas.width,this.height=this.canvas.height,this._super()},enableResize:function(){$(window).on("resize",this.resizeCanvas.bind(this))},disableResize:function(){$(window).off("resize",this.resizeCanvas.bind(this))}});